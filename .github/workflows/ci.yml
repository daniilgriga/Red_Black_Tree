name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
  workflow_dispatch:

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Arch dependencies
        run: pacman -Syu --noconfirm && pacman -S --noconfirm cmake ninja gcc gtest

      - name: Configure and Build Tests
        run: |
          cmake -S . -B build-tests -G Ninja \
                -DCMAKE_BUILD_TYPE=Debug \
                -DBUILD_TESTS=ON \
                -DBUILD_BENCHMARKS=OFF \
                -DENABLE_ASAN=OFF
          cmake --build build-tests

      - name: Run Unit Tests
        run: cd build-tests && ctest --output-on-failure

  debug-asan:
    runs-on: ubuntu-latest
    container: archlinux:latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Arch dependencies
        run: pacman -Syu --noconfirm && pacman -S --noconfirm cmake ninja gcc gtest

      - name: Configure Debug with ASan
        run: |
          cmake -S . -B build-asan -G Ninja \
                -DCMAKE_BUILD_TYPE=Debug \
                -DBUILD_TESTS=ON \
                -DBUILD_BENCHMARKS=OFF \
                -DENABLE_ASAN=ON
          cmake --build build-asan

      - name: Run Unit Tests with ASan
        run: cd build-asan && ctest --output-on-failure

  release-build:
    runs-on: ubuntu-latest
    container: archlinux:latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Arch dependencies
        run: pacman -Syu --noconfirm && pacman -S --noconfirm cmake ninja gcc

      - name: Release build (app + benchmarks)
        run: |
          cmake -S . -B build-release -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DBUILD_TESTS=OFF \
                -DBUILD_BENCHMARKS=ON \
                -DENABLE_ASAN=OFF
          cmake --build build-release
